name: Publish Docker Image and Bundles

on:
  push:
    tags: [v*]
  release:
    types: [published]

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  TAG_VERSION: ""
  IMAGE: ""
  ROBOT_NAME: ${{ github.actor }}
  ROBOT_EMAIL: ${{ github.actor }}@heathmont.net

jobs:
  publish:
    runs-on: ubuntu-latest
    outputs:
      IMAGE: ${{ env.IMAGE }}

    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Get tag version
        id: get_version
        run: echo "TAG_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
      - name: Create Image Name
        run: echo "IMAGE=heathmont/${{ github.event.repository.name }}:${{ env.TAG_VERSION }}" >> $GITHUB_ENV
      - name: Set up Docker Build
        uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: ${{ env.IMAGE }}
          no-cache: true
          build-args: |
            HEX_API_KEY=${{ secrets.HEX_ORGANIZATION_COINGAMING_KEY }}
            SECRET_KEY_BASE=${{ secrets.SECRET_KEY_BASE }}

  deployment:
    name: Update Stacks Docker Compose and trigger Deployment
    runs-on: ubuntu-latest
    needs: publish
    steps:
      - name: Checkout Stacks Repo
        uses: actions/checkout@v4
        with:
          repository: coingaming/stacks
          token: ${{ secrets.GH_TOKEN }}
          ref: sportsbet-t2
          path: stacks
      - name: Update Docker Compose with New Image
        working-directory: stacks
        run: |
          yq -i '.services.moon-surface.image = "${{ needs.publish.outputs.IMAGE }}"' docker-compose.moon.yml

      - name: Commit and Push Changes to docker-compose file
        working-directory: stacks
        run: |
          git config user.email "${{ env.ROBOT_EMAIL }}"
          git config user.name "${{ env.ROBOT_NAME }}"
          git commit -am "Updated Docker image to ${{ needs.publish.outputs.IMAGE }}"
          git push origin sportsbet-t2

  t2_poll_deployment:
    uses: coingaming/framework-workflows/.github/workflows/poll-stacks-deployment.yml@main
    name: Wait until deployment is fully completed
    needs:
      - publish
      - deployment
    with:
      ENV: t2
      SERVICE_NAME: t2-moon_moon-surface
      AWS_REGION: "eu-central-1"
      DOCKER_IMAGE: ${{ needs.publish.outputs.IMAGE }}
    secrets:
      MONITORING_AUTH_TOKEN: ${{ secrets.MONITORING_AUTH_TOKEN }}

  t2_e2e_tests:
    runs-on: ubuntu-latest
    name: Run E2E Tests
    needs: t2_poll_deployment
    steps:
      - name: Trigger E2E tests GHA
        uses: convictional/trigger-workflow-and-wait@v1.6.5
        with:
          owner: coingaming
          repo: platform_e2e_tests
          github_token: ${{ secrets.GH_TOKEN }}
          workflow_file_name: e2e-tests.yml
          client_payload: '{"tests-project": "moon", "tests-environment": "t2", "author": "${{ github.actor }}"}'
          wait_interval: 30
